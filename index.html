<!DOCTYPE html>
<html>
<head>
<title>Face(eyes)! Face(nose)! Face(mouth)!</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="stylesheet" type="text/css" href="css/style.css" />
</head>
<body>
<div class="container">
    <header>
        <h1>Face(eyes)! Face(nose)! Face(mouth)!</h1>
        <div class="buttons">
            <div>
                <span><label for="play">Play</label></span>
                <input id="play" type="checkbox" value="1" checked>
            </div>
            <div>
                <span><label for="switch-camera">Camera switch</label></span>
                <input id="switch-camera" type="checkbox" value="1" checked>
                <span class="desc-switch-camera"><label for="switch-camera">(on: Front / off: Rear)</span>
            </div>
            <div>
                <span><label for="debug">Debug</label></span>
                <input id="debug" type="checkbox" value="1">
            </div>
        </div>
    </header>

    <div id="guiController"></div>

    <div id="wrapper"></div>

    <div id="overlay"></div>
</div>
<script src="js/vendor/stats/stats.min.js"></script>
<script src="js/vendor/clmtrackr/clmtrackr.min.js"></script>
<script src="js/vendor/dat.gui/dat.gui.min.js"></script>
<script src="js/v2c.js"></script>
<script src="js/FaceTracker.js"></script>
<script src="js/FaceParts.js"></script>
<script src="js/FaceCoordinate.js"></script>
<script src="js/Stage.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    'use strict';

    const setPlayButton = (faceTracker) => {
        const playButton = document.querySelector('#play');
        playButton.addEventListener('click', (e) => {
            if (e.target.checked) {
                faceTracker.start();
            } else {
                faceTracker.stop();
            }
        })
    }

    const setUpSwitchCamera = (faceTracker) => {
        const switchCameraButton = document.querySelector('#switch-camera');
        switchCameraButton.addEventListener('click', (e) => {
            faceTracker.switchCamera();
        })
    }

    const setUpDebug = (faceTracker) => {
        const forDebug = document.querySelector('#debug');
        forDebug.addEventListener('change', (e) => {
            if (e.target.checked) {
                faceTracker.startDebug();
            } else {
                faceTracker.stopDebug();
            }
        })
    }

    const setUpParameter = (faceTracker) => {
        const parameter = {
            leftEye: true,
            rightEye: true,
            nose: true,
            mouth: true,
            none: true,
            mosaic: false,
            line:false,
            autoPlace: false
        }

        const gui = new dat.GUI(parameter);
        gui.close();
        document.querySelector('#guiController').appendChild(gui.domElement)

        const facePartsFolder = gui.addFolder('Face Parts');
        facePartsFolder.open();

        const leftEye = new LeftEye(document.createElement('canvas'));
        const leftEyeBlow = new LeftEyeBlow(document.createElement('canvas'));
        const leftEyeController = facePartsFolder.add(parameter, 'leftEye').name('Left Eye');
        if (leftEyeController.getValue() === true) {
            faceTracker.add('leftEye', leftEye);
            faceTracker.add('leftEyeBlow', leftEyeBlow);
        }
        leftEyeController.onChange((checked) => {
            if (checked) {
                faceTracker.add('leftEye', leftEye);
                faceTracker.add('leftEyeBlow', leftEyeBlow);
            } else {
                faceTracker.remove('leftEye');
                faceTracker.remove('leftEyeBlow');
            }
        });

        const rightEye = new RightEye(document.createElement('canvas'));
        const rightEyeBlow = new RightEyeBlow(document.createElement('canvas'));
        const rightEyeController = facePartsFolder.add(parameter, 'rightEye').name('Right Eye');
        if (rightEyeController.getValue() === true) {
            faceTracker.add('rightEye', rightEye);
            faceTracker.add('rightEyeBlow', rightEyeBlow);
        }
        rightEyeController.onChange((checked) => {
            if (checked) {
                faceTracker.add('rightEye', rightEye);
                faceTracker.add('rightEyeBlow', rightEyeBlow);
            } else {
                faceTracker.remove('rightEye');
                faceTracker.remove('rightEyeBlow');
            }
        });

        const nose = new Nose(document.createElement('canvas'));
        const noseController = facePartsFolder.add(parameter, 'nose').name('Nose');
        if (noseController.getValue() === true) {
            faceTracker.add('nose', nose);
        }
        noseController.onChange((checked) => {
            if (checked) {
                faceTracker.add('nose', nose);
            } else {
                faceTracker.remove('nose');
            }
        });

        const mouth = new Mouth(document.createElement('canvas'));
        const mouthController = facePartsFolder.add(parameter, 'mouth').name('Mouth');
        if (mouthController.getValue() === true) {
            faceTracker.add('mouth', mouth);
        }
        mouthController.onChange((checked) => {
            if (checked) {
                faceTracker.add('mouth', mouth);
            } else {
                faceTracker.remove('mouth');
            }
        });

        const eyeLine = gui.addFolder('Eye Line');
        eyeLine.open();

        const none = eyeLine.add(parameter, 'none').listen().onChange(() => setEyeLine('none'));
        const mosaic = eyeLine.add(parameter, 'mosaic').listen().onChange(() => setEyeLine('mosaic'));
        const line = eyeLine.add(parameter, 'line').listen().onChange(() => setEyeLine('line'));

        const setEyeLine = (prop) => {
            for (let param in parameter){
                parameter[param] = false;
            }
            parameter[prop] = true;

            if (prop !== 'none') {
                faceTracker.addEyeLine(prop);
                return;
            }
            faceTracker.addEyeLine('');
        }
    }

    const setUp = (faceTracker) => {
        setPlayButton(faceTracker);
        setUpSwitchCamera(faceTracker);
        setUpDebug(faceTracker);
        setUpParameter(faceTracker);
    }

    const measureSize = () => {
        let _o = window.orientation;
        let _orientation = _o === undefined ? 90 : _o;
        if (_orientation === 0 || _orientation === 180) {
            return window.innerHeight;
        }
        return window.innerWidth;
    }

    const callbackOnLoadedmetadataVideo = video => {
        faceTracker.setUp(video);
    }

    const callbackOnAfterVideoLoadError = err => {
        alert(err);
    }

    const option = {
        'longSideSize': measureSize(),
        'callbackOnLoadedmetadataVideo': callbackOnLoadedmetadataVideo,
        'callbackOnAfterVideoLoadError': callbackOnAfterVideoLoadError,
    };

    const v2c = new V2C('#wrapper', option);
    const ctracker = new clm.tracker();
    const faceCoordinate = new FaceCoordinate();
    const stage = new Stage('#overlay');
    const faceTracker = new FaceTracker(v2c, ctracker, faceCoordinate, stage);

    setUp(faceTracker);
    faceTracker.start();
});
</script>
</body>
</html>
